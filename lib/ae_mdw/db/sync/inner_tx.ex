defmodule AeMdw.Db.Sync.InnerTx do

  alias AeMdw.Db.Sync.Transaction, as: SyncTx

  ##########
  
  def mod_tx(tx) when elem(tx, 0) == :signed_tx,
    do: mod_tx(:aetx.specialize_callback(:aetx_sign.tx(tx)))
  def mod_tx({_, tx}) when elem(tx, 0) == :ga_meta_tx,
    do: mod_tx(:aega_meta_tx.tx(tx))
  def mod_tx({_, tx}) when elem(tx, 0) == :paying_for_tx,
    do: mod_tx(:aec_paying_for_tx.tx(tx))
  def mod_tx({mod, tx}),
    do: {mod, tx}
        
  def sync(signed_outer_tx, txi, tx_hash, bi, mb_time, mb_events) do
    inner_txi = txi + 1
    {mod, inner_tx} = mod_tx(signed_outer_tx)
    inner_aetx = :aetx.new(mod, inner_tx)
    inner_signed_tx = :aetx_sign.new(inner_aetx, [])
    inner_type = mod.type()

    SyncTx.write_data(inner_type, inner_txi, tx_hash, bi, mb_time, true)
    SyncTx.write_fields(inner_type, inner_tx, inner_txi, bi)
    SyncTx.write_links(inner_type, inner_tx, inner_signed_tx, inner_txi, tx_hash, bi, mb_time, mb_events)
    inner_txi + 1
  end
  
end


##########

# [

#   {:signed_tx,
#    {:aetx, :ga_meta_tx, :aega_meta_tx, 255,
# 	{:ga_meta_tx,
# 	 {:id, :account,
# 	  <<46, 226, 147, 177, 55, 148, 48, 173, 254, 167, 218, 121, 34, 199, 164,
# 	  233, 255, 189, 0, 51, 91, 2, 204, 152, 240, 173, 3, 76, 223, 251, 205,
# 	  143>>}, <<43, 17, 244, 119, 202, 45, 27, 255>>, 3, 50000, 1000000000,
# 	 80100000000000, 0,
# 	 {:signed_tx,
# 	  {:aetx, :oracle_response_tx, :aeo_response_tx, 182,
# 	   {:oracle_response_tx,
# 	    {:id, :oracle,
# 	     <<46, 226, 147, 177, 55, 148, 48, 173, 254, 167, 218, 121, 34, 199, 164,
#          233, 255, 189, 0, 51, 91, 2, 204, 152, 240, 173, 3, 76, 223, 251, 205,
#          143>>}, 0,
# 	    <<155, 159, 157, 5, 165, 192, 35, 45, 174, 109, 171, 24, 246, 93, 200,
#         245, 175, 145, 187, 220, 151, 216, 90, 213, 138, 23, 13, 241, 116, 219,
#         254, 95>>,
# 	    <<0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#         0, 0, 0, 0, 0, 0, 0, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 119, 111, 114, 108, 100,
#         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#         0, 0, 0>>, {:delta, 900}, 18805000000000, 0}}, []}}}, []},
  
#   {:signed_tx,
#    {:aetx, :paying_for_tx, :aec_paying_for_tx, 301,
# 	{:paying_for_tx,
# 	 {:id, :account,
# 	  <<177, 185, 88, 218, 11, 161, 143, 41, 113, 141, 143, 136, 99, 136, 168,
# 	  183, 225, 167, 85, 243, 80, 201, 23, 170, 107, 205, 49, 69, 89, 172, 2,
# 	  134>>}, 2, 300000000000000,
# 	 {:signed_tx,
# 	  {:aetx, :spend_tx, :aec_spend_tx, 177,
# 	   {:spend_tx,
# 	    {:id, :account,
# 	     <<225, 161, 164, 42, 119, 45, 80, 251, 186, 225, 43, 63, 4, 191, 52, 170,
#          149, 24, 108, 124, 235, 239, 12, 36, 66, 144, 140, 255, 68, 57, 253,
#          114>>},
# 	    {:id, :account,
# 	     <<136, 61, 13, 231, 16, 17, 71, 6, 104, 35, 6, 178, 252, 108, 10, 224,
#          67, 28, 70, 104, 210, 145, 83, 68, 80, 5, 66, 227, 253, 74, 174, 20>>},
# 	    2000000000000000000, 300000000000000, 0, 2,
# 	    "yeah, somebody else payed the tx fee for this transaction to an unknown recipient =)"}},
# 	  [
# 	  <<103, 197, 222, 184, 133, 57, 253, 57, 241, 177, 30, 236, 194, 210, 211,
#       79, 178, 230, 149, 179, 175, 83, 99, 120, 150, 66, 59, 137, 129, 217,
#       155, 80, 87, 141, 12, 86, 135, 42, 131, 33, 69, 221, 11, 53, 6, 160, 75,
#       134, 216, 179, 119, 138, 73, 162, 106, 64, 153, 174, 39, 84, 83, 46,
#       173, 8>>
# 	  ]}}}, []},

#   {:signed_tx,
#    {:aetx, :ga_meta_tx, :aega_meta_tx, 255,
# 	{:ga_meta_tx,
# 	 {:id, :account,
# 	  <<46, 226, 147, 177, 55, 148, 48, 173, 254, 167, 218, 121, 34, 199, 164,
# 	  233, 255, 189, 0, 51, 91, 2, 204, 152, 240, 173, 3, 76, 223, 251, 205,
# 	  143>>}, <<43, 17, 244, 119, 202, 45, 27, 255>>, 3, 50000, 1000000000,
# 	 80100000000000, 0,
# 	 {:signed_tx,
# 	  {:aetx, :oracle_response_tx, :aeo_response_tx, 182,
# 	   {:oracle_response_tx,
# 	    {:id, :oracle,
# 	     <<46, 226, 147, 177, 55, 148, 48, 173, 254, 167, 218, 121, 34, 199, 164,
#          233, 255, 189, 0, 51, 91, 2, 204, 152, 240, 173, 3, 76, 223, 251, 205,
#          143>>}, 0,
# 	    <<155, 159, 157, 5, 165, 192, 35, 45, 174, 109, 171, 24, 246, 93, 200,
#         245, 175, 145, 187, 220, 151, 216, 90, 213, 138, 23, 13, 241, 116, 219,
#         254, 95>>,
# 	    <<0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#         0, 0, 0, 0, 0, 0, 0, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 119, 111, 114, 108, 100,
#         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#         0, 0, 0>>, {:delta, 900}, 18805000000000, 0}}, []}}}, []},

#   {:signed_tx,
#    {:aetx, :paying_for_tx, :aec_paying_for_tx, 301,
# 	{:paying_for_tx,
# 	 {:id, :account,
# 	  <<177, 185, 88, 218, 11, 161, 143, 41, 113, 141, 143, 136, 99, 136, 168,
# 	  183, 225, 167, 85, 243, 80, 201, 23, 170, 107, 205, 49, 69, 89, 172, 2,
# 	  134>>},
# 	 2,
# 	 300000000000000,
# 	 {:signed_tx,
# 	  {:aetx, :ga_meta_tx, :aega_meta_tx, 255,
# 	   {:ga_meta_tx,
# 	    {:id, :account,
# 	     <<46, 226, 147, 177, 55, 148, 48, 173, 254, 167, 218, 121, 34, 199, 164,
# 	     233, 255, 189, 0, 51, 91, 2, 204, 152, 240, 173, 3, 76, 223, 251, 205,
# 	     143>>}, <<43, 17, 244, 119, 202, 45, 27, 255>>, 3, 50000, 1000000000,
# 	    80100000000000, 0,
# 	    {:signed_tx,
# 	     {:aetx, :oracle_response_tx, :aeo_response_tx, 182,
# 	      {:oracle_response_tx,
# 	       {:id, :oracle,
# 		<<46, 226, 147, 177, 55, 148, 48, 173, 254, 167, 218, 121, 34, 199, 164,
# 		233, 255, 189, 0, 51, 91, 2, 204, 152, 240, 173, 3, 76, 223, 251, 205,
# 		143>>}, 0,
# 	       <<155, 159, 157, 5, 165, 192, 35, 45, 174, 109, 171, 24, 246, 93, 200,
#            245, 175, 145, 187, 220, 151, 216, 90, 213, 138, 23, 13, 241, 116, 219,
#            254, 95>>,
# 	       <<0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#            0, 0, 0, 0, 0, 0, 0, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 119, 111, 114, 108, 100,
#            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
#            0, 0, 0>>, {:delta, 900}, 18805000000000, 0}}, []}}}, []}}},
#    [<<103, 197, 222, 184, 133, 57, 253, 57, 241, 177, 30, 236, 194, 210, 211,
#    79, 178, 230, 149, 179, 175, 83, 99, 120, 150, 66, 59, 137, 129, 217,
#    155, 80, 87, 141, 12, 86, 135, 42, 131, 33, 69, 221, 11, 53, 6, 160, 75,
#    134, 216, 179, 119, 138, 73, 162, 106, 64, 153, 174, 39, 84, 83, 46,
#    173, 8>>]}

# ]
